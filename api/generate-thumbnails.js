import puppeteer from 'puppeteer';

export default async function handler(req, res) {
    // Handle CORS
  res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
        return res.status(200).end();
  }

  if (req.method !== 'POST') {
        return res.status(405).json({ error: 'Method not allowed' });
  }

  let browser;

  try {
        const { title, style = 'tokenized-blue' } = req.body || {};

      if (!title) {
              return res.status(400).json({ error: 'Title is required' });
      }

      // Launch headless browser
      browser = await puppeteer.launch({
              headless: true,
              args: ['--no-sandbox', '--disable-setuid-sandbox']
      });

      const page = await browser.newPage();

      // Set viewport to YouTube thumbnail size (1280x720)
      await page.setViewport({ width: 1280, height: 720 });

      // Generate HTML for thumbnail based on style
      const html = generateThumbnailHTML(title, style);

      await page.setContent(html);

      // Take screenshot
      const screenshot = await page.screenshot({
              type: 'png',
              encoding: 'base64'
      });

      await browser.close();

      return res.status(200).json({
              success: true,
              image: `data:image/png;base64,${screenshot}`,
              style: style
      });

  } catch (error) {
        console.error('Thumbnail generation error:', error);
        if (browser) {
                await browser.close();
        }
        return res.status(500).json({
                error: 'Failed to generate thumbnail',
                details: error.message
        });
  }
}

function generateThumbnailHTML(title, style) {
    // Split title into main text and subtitle if it contains a colon or dash
  let mainText = title;
    let subText = '';

  if (title.includes(':')) {
        [mainText, subText] = title.split(':').map(s => s.trim());
  } else if (title.includes(' - ')) {
        [mainText, subText] = title.split(' - ').map(s => s.trim());
  }

  // Different style configurations matching Tokenized YouTube channel
  const styles = {
        'tokenized-blue': {
                background: 'linear-gradient(135deg, #0066cc 0%, #0052a3 100%)',
                mainTextColor: '#000000',
                subTextColor: '#ffffff',
                textShadow: 'none',
                fontWeight: '900',
                layout: 'right-aligned'
        },
        'gradient-purple': {
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                mainTextColor: '#ffffff',
                subTextColor: '#e0e7ff',
                textShadow: '4px 4px 8px rgba(0, 0, 0, 0.3)',
                fontWeight: '900',
                layout: 'right-aligned'
        },
        'dark-dramatic': {
                background: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)',
                mainTextColor: '#00c8ff',
                subTextColor: '#ffffff',
                textShadow: '0 0 20px rgba(0, 200, 255, 0.5)',
                fontWeight: '900',
                layout: 'right-aligned'
        },
        'bold-contrast': {
                background: '#000000',
                mainTextColor: '#00ff88',
                subTextColor: '#ffffff',
                textShadow: '3px 3px 0 #000000',
                fontWeight: '900',
                layout: 'right-aligned'
        }
  };

  const styleConfig = styles[style] || styles['tokenized-blue'];

  return `
      <!DOCTYPE html>
          <html>
              <head>
                    <link rel="preconnect" href="https://fonts.googleapis.com">
                          <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                                <link href="https://fonts.googleapis.com/css2?family=Inter:wght@700;900&display=swap" rel="stylesheet">
                                      <style>
                                              * {
                                                        margin: 0;
                                                                  padding: 0;
                                                                            box-sizing: border-box;
                                                                                    }

                                                                                            body {
                                                                                                      width: 1280px;
                                                                                                                height: 720px;
                                                                                                                          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                                                                                                                                    background: ${styleConfig.background};
                                                                                                                                              display: flex;
                                                                                                                                                        align-items: center;
                                                                                                                                                                  justify-content: center;
                                                                                                                                                                            overflow: hidden;
                                                                                                                                                                                    }
                                                                                                                                                                                    
                                                                                                                                                                                            .thumbnail-container {
                                                                                                                                                                                                      width: 100%;
                                                                                                                                                                                                                height: 100%;
                                                                                                                                                                                                                          display: flex;
                                                                                                                                                                                                                                    align-items: center;
                                                                                                                                                                                                                                              padding: 60px 80px;
                                                                                                                                                                                                                                                        position: relative;
                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                        .text-content {
                                                                                                                                                                                                                                                                                  flex: 1;
                                                                                                                                                                                                                                                                                            display: flex;
                                                                                                                                                                                                                                                                                                      flex-direction: column;
                                                                                                                                                                                                                                                                                                                justify-content: center;
                                                                                                                                                                                                                                                                                                                          gap: 20px;
                                                                                                                                                                                                                                                                                                                                    ${styleConfig.layout === 'right-aligned' ? 'text-align: left; margin-left: auto; max-width: 65%;' : 'text-align: left;'}
                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                    .main-text {
                                                                                                                                                                                                                                                                                                                                                              font-size: ${mainText.length > 30 ? '72px' : '88px'};
                                                                                                                                                                                                                                                                                                                                                                        font-weight: ${styleConfig.fontWeight};
                                                                                                                                                                                                                                                                                                                                                                                  color: ${styleConfig.mainTextColor};
                                                                                                                                                                                                                                                                                                                                                                                            line-height: 1.1;
                                                                                                                                                                                                                                                                                                                                                                                                      text-transform: uppercase;
                                                                                                                                                                                                                                                                                                                                                                                                                letter-spacing: -2px;
                                                                                                                                                                                                                                                                                                                                                                                                                          ${styleConfig.textShadow ? `text-shadow: ${styleConfig.textShadow};` : ''}
                                                                                                                                                                                                                                                                                                                                                                                                                                    word-wrap: break-word;
                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                    .sub-text {
                                                                                                                                                                                                                                                                                                                                                                                                                                                              font-size: 36px;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        font-weight: 700;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  color: ${styleConfig.subTextColor};
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            line-height: 1.3;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      opacity: 0.95;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      .logo {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                position: absolute;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          bottom: 40px;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    left: 60px;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              font-size: 32px;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        font-weight: 900;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  color: rgba(255, 255, 255, 0.9);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            text-transform: uppercase;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      letter-spacing: 2px;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      .accent-bar {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                position: absolute;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          left: 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    top: 50%;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              transform: translateY(-50%);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        width: 12px;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  height: 200px;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            background: ${styleConfig.mainTextColor};
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      opacity: 0.6;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </style>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </head>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <body>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div class="thumbnail-container">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <div class="accent-bar"></div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div class="text-content">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="main-text">${mainText}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ${subText ? `<div class="sub-text">${subText}</div>` : ''}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <div class="logo">TOKENIZED</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </body>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </html>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      `;
}
